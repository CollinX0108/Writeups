name: Generate PDF from Markdown

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'HTB/**/*.md'

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-xetex texlive-fonts-recommended texlive-latex-extra
      
      - name: Download EISVOGEL template
        run: |
          mkdir -p ~/.pandoc/templates
          # Descargar el template desde el release
          curl -L https://github.com/Wandmalfarbe/pandoc-latex-template/releases/download/3.2.1/Eisvogel-3.2.1.tar.gz -o /tmp/eisvogel.tar.gz
          # Verificar que se descargó
          if [ ! -f /tmp/eisvogel.tar.gz ]; then
            echo "Error: No se pudo descargar el template"
            exit 1
          fi
          # Extraer
          tar -xzf /tmp/eisvogel.tar.gz -C /tmp
          # Buscar y copiar el archivo eisvogel.latex
          TEMPLATE_FILE=$(find /tmp -name "eisvogel.latex" | head -1)
          if [ -z "$TEMPLATE_FILE" ]; then
            echo "Error: No se encontró eisvogel.latex en el archivo descargado"
            ls -la /tmp/
            exit 1
          fi
          cp "$TEMPLATE_FILE" ~/.pandoc/templates/eisvogel.latex
          ls -lh ~/.pandoc/templates/eisvogel.latex
          echo "Template instalado correctamente"
      
      - name: Generate PDFs
        run: |
          find HTB -name "writeup.md" | while read file; do
            dir=$(dirname "$file")
            cd "$dir"
            pandoc --pdf-engine=xelatex writeup.md -o writeup.pdf --template eisvogel --listings
            cd - > /dev/null
          done
      
      - name: Upload PDFs
        uses: actions/upload-artifact@v4
        with:
          name: pdf-writeups
          path: HTB/**/*.pdf
